#!/bin/sh
set -e

blocked_files_regex='(^|/)\.env(\.|$)|\.(pem|key|p12|pfx|crt|der|jks|keystore|pkcs12|pkcs8)$|(^|/)\.ssh(/|$)'

staged_files="$(git diff --cached --name-only --diff-filter=ACMR)"

if [ -z "$staged_files" ]; then
  exit 0
fi

for file in $staged_files; do
  case "$file" in
    .env.example)
      continue
      ;;
  esac

  if printf "%s\n" "$file" | grep -Eq "$blocked_files_regex"; then
    echo "❌ Refusing to commit secret file: $file"
    echo "   Use .env.example and keep real secrets out of git."
    exit 1
  fi

  if [ -f "$file" ] && grep -Eq "-----BEGIN (OPENSSH|RSA|EC|DSA|ED25519|PRIVATE) KEY-----" "$file"; then
    echo "❌ Refusing to commit a private key block in: $file"
    exit 1
  fi
done

exit 0
