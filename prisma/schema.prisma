// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiKey {
  id              String   @id @default(cuid())
  service         String   @unique // "gemini", "airtable", "resend"
  key             String   // encrypted
  status          String   @default("disconnected")
  
  // Gemini-specific
  geminiModel     String?  @default("gemini-2.0-flash-exp")
  
  // Airtable-specific
  airtableBaseId    String?
  airtableBaseName  String?
  airtableTableId   String?
  airtableTableName String?
  
  // Resend-specific
  resendFromName  String?  @default("Adrian & Jimmy from \"AI Product Briefing\"")
  resendFromEmail String?  @default("hello@jimmy-iliohan.com")
  
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())
}

model RssSource {
  id        String   @id @default(cuid())
  name      String
  url       String   @unique
  category  String?
  enabled   Boolean  @default(true)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Article {
  id                  String   @id @default(cuid())
  title               String
  category            String
  creator             String
  aiSummary           String   @db.Text
  whyItMatters        String   @db.Text
  businessValue       String   @db.Text
  publishedDate       DateTime
  sourceLink          String
  canonicalLink       String   @unique
  imageLink           String?
  ingestedAt          DateTime @default(now())
  daysSincePublished  Int
  isRecent            Boolean  @default(true)
}

model Sequence {
  id            String   @id @default(cuid())
  name          String
  audienceId    String   // Resend segment ID
  schedule      String   // Cron expression
  dayOfWeek     String[] // ["monday", "tuesday"]
  time          String   // "09:00"
  timezone      String   @default("UTC")
  systemPrompt  String?  @db.Text
  userPrompt    String   @db.Text
  templateId    String?  // NewsletterTemplate ID (null = use default)
  layout        Json?    // [{ componentId: "x", order: 1 }, ...]
  status        String   @default("draft") // draft, active, paused
  lastSent      DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  status    String   @default("active") // active, unsubscribed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id         String              @id @default(cuid())
  type       String              @unique // "welcome", "newsletter"
  subject    String?
  html       String              @db.Text
  enabled    Boolean             @default(true)
  templateId String?
  template   NewsletterTemplate? @relation(fields: [templateId], references: [id])
  updatedAt  DateTime            @updatedAt
  createdAt  DateTime            @default(now())
}

model IngestionConfig {
  id           String   @id @default(cuid())
  schedule     String[] // ["monday", "wednesday", "friday"]
  time         String   @default("09:00")
  timezone     String   @default("America/New_York")
  timeFrame    Int      @default(72) // hours to look back
  systemPrompt String   @db.Text
  userPrompt   String   @db.Text
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

model NewsActivity {
  id        String   @id @default(cuid())
  event     String
  status    String   @default("info")
  message   String   @db.Text
  metadata  Json?
  createdAt DateTime @default(now())
}

model NewsletterTemplate {
  id             String          @id @default(cuid())
  name           String
  description    String?         @db.Text
  html           String          @db.Text
  isDefault      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  emailTemplates EmailTemplate[]
}
model ShortLink {
  id         String   @id @default(cuid())
  shortCode  String   @unique
  targetUrl  String
  articleId  String?
  sequenceId String?
  clicks     Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([shortCode])
  @@index([articleId])
  @@index([sequenceId])
}

model EmailEvent {
  id          String   @id @default(cuid())
  eventId     String?  @unique
  eventType   String
  emailId     String?
  broadcastId String?
  recipient   String?
  subject     String?
  clickUrl    String?
  payload     Json?
  createdAt   DateTime @default(now())

  @@index([eventType])
  @@index([emailId])
  @@index([broadcastId])
  @@index([createdAt])
}

model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DataSource {
  id           String    @id @default(cuid())
  name         String    @unique // "news", "chefs_table", "recipes", "cooking"
  type         String    // "rss_airtable", "airtable"
  tableId      String?
  tableName    String?
  viewId       String?
  viewName     String?
  fieldMapping Json?     // { title: "Name", content: "Description", ... }
  syncStatus   String    @default("idle") // "idle", "syncing", "success", "error"
  lastSyncAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  components   NewsletterComponent[]
}

model NewsletterComponent {
  id             String      @id @default(cuid())
  name           String      // User-defined display name
  description    String?     @db.Text // Internal admin reference
  type           String      // "data", "static", "system"
  dataSourceId   String?     // FK to DataSource (null for static/system)
  dataSource     DataSource? @relation(fields: [dataSourceId], references: [id])
  displayOptions Json?       // { maxItems: 5, layout: "cards", fieldMap: {...} }
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

// Weekly Newsletter - Saved Content from Mobile
model SavedContent {
  id          String   @id @default(cuid())
  type        String   // "recipe" (social/articles), "cooking" (experiments)
  title       String
  url         String?
  description String?  @db.Text
  imageUrl    String?
  source      String?  // e.g., "twitter", "linkedin", "article"
  notes       String?  @db.Text // personal notes
  used        Boolean  @default(false) // whether it's been used in a newsletter
  usedInId    String?  // which WeeklyNewsletter it was used in
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([used])
  @@index([createdAt])
}

// Weekly Newsletter Issue
model WeeklyNewsletter {
  id              String   @id @default(cuid())
  weekStart       DateTime // Monday of the week
  weekEnd         DateTime // Sunday of the week
  status          String   @default("draft") // draft, scheduled, sent

  // Chef's Table - AI intro with context
  chefsTableTitle String?
  chefsTableBody  String?  @db.Text

  // News section - pulled from Airtable (stored as JSON for flexibility)
  newsItems       Json?    // [{ title, url, summary }] - top 3 from Airtable

  // Recipes - saved social/articles
  recipeIds       String[] // SavedContent IDs

  // What We're Cooking - experiments
  cookingItems    Json?    // [{ title, description, url }]

  // AI Generation
  systemPrompt    String?  @db.Text
  generatedAt     DateTime?

  // Sending
  audienceId      String?
  sentAt          DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([weekStart])
  @@index([status])
}
